#!/data/data/com.termux/files/usr/bin/bash
set -euo pipefail

# --- Paths ---
S="$HOME/.shortcuts"
B="$HOME/.bashrc"
D="$HOME/termux-backup"
LOG="$D/sync_history.csv"
DEVICE=$(getprop ro.product.model | tr -d ' ')

echo "ðŸ§¹ Cleaning up redundant scripts..."
# Force remove old junk from Git tracking if they exist in the backup folder
cd "$D"
git rm -f book-sum backup-shortcuts backup-folder 2>/dev/null || echo "â†’ Junk already gone from Git index."

echo "ðŸ“‚ Syncing local system -> Backup folder..."
mkdir -p "$D/.shortcuts"

# Ensure .hidden exists and has a .gitkeep
H="$S/.hidden"
if [ -d "$H" ] && [ -z "$(ls -A "$H" 2>/dev/null)" ]; then
    touch "$H/.gitkeep"
fi

# Copy everything to backup folder
cp -rT "$S" "$D/.shortcuts"
[ -f "$B" ] && cp -f "$B" "$D/.bashrc"

# --- Log Device Info ---
[ ! -f "$LOG" ] && echo "Timestamp,Device,Action" > "$LOG"
echo "$(date '+%Y-%m-%d %H:%M:%S'),$DEVICE,PUSH_BACKUP" >> "$LOG"

# --- Git Push ---
git add -A .
if ! git diff-index --quiet HEAD --; then
    git commit -m "Backup from $DEVICE: System cleanup and segment update"
    echo "ðŸ“¤ Pushing to GitHub..."
    git push origin main
else
    echo "âœ… Everything already backed up."
fi
